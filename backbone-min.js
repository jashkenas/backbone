// Backbone.js 0.9.2

// (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
// Backbone may be freely distributed under the MIT license.
// For all details and documentation:
// http://backbonejs.org
(function(){var n=this,A=n.Backbone,B=Array.prototype.slice,C=Array.prototype.splice,h;h=typeof exports!=="undefined"?exports:n.Backbone={};h.VERSION="0.9.2";var f=n._;if(!f&&typeof require!=="undefined")f=require("underscore");var l=n.jQuery||n.Zepto||n.ender;h.setDomLibrary=function(a){l=a};h.noConflict=function(){n.Backbone=A;return this};h.emulateHTTP=false;h.emulateJSON=false;var r=/\s+/,m=h.Events={isBackboneEvents:true,on:function(a,b,c){var d,e,g,i,j;if(!b)return this;a=a.split(r);for(d=this._callbacks||
(this._callbacks={});e=a.shift();){g=(j=d[e])?j.tail:{};g.next=i={};g.context=c;g.callback=b;d[e]={tail:i,next:j?j.next:g}}return this},off:function(a,b,c){var d,e,g,i,j,k;if(e=this._callbacks){if(!(a||b||c)){delete this._callbacks;return this}for(a=a?a.split(r):f.keys(e);d=a.shift();){g=e[d];delete e[d];if(g&&(b||c))for(i=g.tail;(g=g.next)!==i;){j=g.callback;k=g.context;if(b&&j!==b||c&&k!==c)this.on(d,j,k)}}return this}},trigger:function(a){var b,c,d,e,g,i;if(!(d=this._callbacks))return this;g=d.all;
a=a.split(r);for(i=B.call(arguments,1);b=a.shift();){if(c=d[b])for(e=c.tail;(c=c.next)!==e;)c.callback.apply(c.context||this,i);if(c=g){e=c.tail;for(b=[b].concat(i);(c=c.next)!==e;)c.callback.apply(c.context||this,b)}}return this}};m.bind=m.on;m.unbind=m.off;var s=h.Model=function(a,b){var c;a||(a={});if(b&&b.parse)a=this.parse(a);if(c=p(this,"defaults"))a=f.extend({},c,a);if(b&&b.collection)this.collection=b.collection;this.attributes={};this._escapedAttributes={};this.cid=f.uniqueId("c");this.changed=
{};this._silent={};this._pending={};this.set(a,{silent:true});this.changed={};this._silent={};this._pending={};this._previousAttributes=f.clone(this.attributes);this.initialize.apply(this,arguments)};f.extend(s.prototype,m,{isBackboneModel:true,changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(){return f.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var b;if(b=this._escapedAttributes[a])return b;b=this.get(a);return this._escapedAttributes[a]=
f.escape(b==null?"":""+b)},has:function(a){return this.get(a)!=null},set:function(a,b,c){var d,e;if(f.isObject(a)||a==null){d=a;c=b}else{d={};d[a]=b}c||(c={});if(!d)return this;if(d.isBackboneModel)d=d.attributes;if(c.unset)for(e in d)d[e]=void 0;if(!this._validate(d,c))return false;if(this.idAttribute in d)this.id=d[this.idAttribute];b=c.changes={};var g=this.attributes,i=this._escapedAttributes,j=this._previousAttributes||{};for(e in d){a=d[e];if(!f.isEqual(g[e],a)||c.unset&&f.has(g,e)){delete i[e];
(c.silent?this._silent:b)[e]=true}c.unset?delete g[e]:g[e]=a;if(!f.isEqual(j[e],a)||f.has(g,e)!=f.has(j,e)){this.changed[e]=a;c.silent||(this._pending[e]=true)}else{delete this.changed[e];delete this._pending[e]}}c.silent||this.change(c);return this},unset:function(a,b){(b||(b={})).unset=true;return this.set(a,null,b)},clear:function(a){(a||(a={})).unset=true;return this.set(f.clone(this.attributes),a)},fetch:function(a){a=a?f.clone(a):{};var b=this,c=a.success;a.success=function(d,e,g){if(!b.set(b.parse(d,
g),a))return false;c&&c(b,d)};a.error=h.wrapError(a.error,b,a);return(this.sync||h.sync).call(this,"read",this,a)},save:function(a,b,c){var d,e;if(f.isObject(a)||a==null){d=a;c=b}else{d={};d[a]=b}c=c?f.clone(c):{};if(c.wait){if(!this._validate(d,c))return false;e=f.clone(this.attributes)}a=f.extend({},c,{silent:true});if(d&&!this.set(d,c.wait?a:c))return false;var g=this,i=c.success;c.success=function(j,k,q){k=g.parse(j,q);if(c.wait){delete c.wait;k=f.extend(d||{},k)}if(!g.set(k,c))return false;i?
i(g,j):g.trigger("sync",g,j,c)};c.error=h.wrapError(c.error,g,c);b=this.isNew()?"create":"update";b=(this.sync||h.sync).call(this,b,this,c);c.wait&&this.set(e,a);return b},destroy:function(a){a=a?f.clone(a):{};var b=this,c=a.success,d=function(){b.trigger("destroy",b,b.collection,a)};if(this.isNew()){d();return false}a.success=function(g){a.wait&&d();c?c(b,g):b.trigger("sync",b,g,a)};a.error=h.wrapError(a.error,b,a);var e=(this.sync||h.sync).call(this,"delete",this,a);a.wait||d();return e},url:function(){var a=
p(this,"urlRoot")||p(this.collection,"url")||v();if(this.isNew())return a;return a+(a.charAt(a.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(a){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(a){a||(a={});var b=this._changing;this._changing=true;for(var c in this._silent)this._pending[c]=true;var d=f.extend({},a.changes,this._silent);this._silent={};for(c in d)this.trigger("change:"+c,this,this.get(c),
a);if(b)return this;for(;!f.isEmpty(this._pending);){this._pending={};this.trigger("change",this,a);for(c in this.changed)this._pending[c]||this._silent[c]||delete this.changed[c];this._previousAttributes=f.clone(this.attributes)}this._changing=false;return this},hasChanged:function(a){if(!arguments.length)return!f.isEmpty(this.changed);return f.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?f.clone(this.changed):false;var b,c=false,d=this._previousAttributes,e;
for(e in a)if(!f.isEqual(d[e],b=a[e]))(c||(c={}))[e]=b;return c},previous:function(a){if(!arguments.length||!this._previousAttributes)return null;return this._previousAttributes[a]},previousAttributes:function(){return f.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(a,b){if(b.silent||!this.validate)return true;a=f.extend({},this.attributes,a);var c=this.validate(a,b);if(!c)return true;b&&b.error?b.error(this,c,b):this.trigger("error",
this,c,b);return false}});var t=h.Collection=function(a,b){b||(b={});if(b.model)this.model=b.model;if(b.comparator)this.comparator=b.comparator;this._reset();this.initialize.apply(this,arguments);a&&this.reset(a,{silent:true,parse:b.parse})};f.extend(t.prototype,m,{isBackboneCollection:true,model:s,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},add:function(a,b){var c,d,e,g,i,j={},k={},q=[];b||(b={});a=f.isArray(a)?a.slice():[a];c=0;for(d=a.length;c<d;c++){if(!(e=
a[c]=this._prepareModel(a[c],b)))throw Error("Can't add an invalid model to a collection");g=e.cid;i=e.id;if(j[g]||this._byCid[g]||i!=null&&(k[i]||this._byId[i]))q.push(c);else j[g]=k[i]=e}for(c=q.length;c--;)a.splice(q[c],1);c=0;for(d=a.length;c<d;c++){(e=a[c]).on("all",this._onModelEvent,this);this._byCid[e.cid]=e;if(e.id!=null)this._byId[e.id]=e}this.length+=d;C.apply(this.models,[b.at!=null?b.at:this.models.length,0].concat(a));this.comparator&&this.sort({silent:true});if(b.silent)return this;
c=0;for(d=this.models.length;c<d;c++)if(j[(e=this.models[c]).cid]){b.index=c;e.trigger("add",e,this,b)}return this},remove:function(a,b){var c,d,e,g;b||(b={});a=f.isArray(a)?a.slice():[a];c=0;for(d=a.length;c<d;c++)if(g=this.getByCid(a[c])||this.get(a[c])){delete this._byId[g.id];delete this._byCid[g.cid];e=this.indexOf(g);this.models.splice(e,1);this.length--;if(!b.silent){b.index=e;g.trigger("remove",g,this,b)}this._removeReference(g)}return this},push:function(a,b){a=this._prepareModel(a,b);this.add(a,
b);return a},pop:function(a){var b=this.at(this.length-1);this.remove(b,a);return b},unshift:function(a,b){a=this._prepareModel(a,b);this.add(a,f.extend({at:0},b));return a},shift:function(a){var b=this.at(0);this.remove(b,a);return b},get:function(a){if(a!=null)return this._byId[a.id!=null?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},where:function(a){if(f.isEmpty(a))return[];return this.filter(function(b){for(var c in a)if(a[c]!==b.get(c))return false;
return true})},sort:function(a){a||(a={});if(!this.comparator)throw Error("Cannot sort a set without a comparator");var b=f.bind(this.comparator,this);if(this.comparator.length==1)this.models=this.sortBy(b);else this.models.sort(b);a.silent||this.trigger("reset",this,a);return this},pluck:function(a){return f.map(this.models,function(b){return b.get(a)})},reset:function(a,b){a||(a=[]);b||(b={});for(var c=0,d=this.models.length;c<d;c++)this._removeReference(this.models[c]);this._reset();this.add(a,
f.extend({silent:true},b));b.silent||this.trigger("reset",this,b);return this},fetch:function(a){a=a?f.clone(a):{};if(a.parse===undefined)a.parse=true;var b=this,c=a.success;a.success=function(d,e,g){b[a.add?"add":"reset"](b.parse(d,g),a);c&&c(b,d)};a.error=h.wrapError(a.error,b,a);return(this.sync||h.sync).call(this,"read",this,a)},create:function(a,b){var c=this;b=b?f.clone(b):{};a=this._prepareModel(a,b);if(!a)return false;b.wait||c.add(a,b);var d=b.success;b.success=function(e,g){b.wait&&c.add(e,
b);d?d(e,g):e.trigger("sync",a,g,b)};a.save(null,b);return a},parse:function(a){return a},chain:function(){return f(this.models).chain()},_reset:function(){this.length=0;this.models=[];this._byId={};this._byCid={}},_prepareModel:function(a,b){b||(b={});if(a.isBackboneModel){if(!a.collection)a.collection=this}else{var c;b.collection=this;a=new this.model(a,b);a._validate(a.attributes,b)||(a=false)}return a},_removeReference:function(a){this==a.collection&&delete a.collection;a.off("all",this._onModelEvent,
this)},_onModelEvent:function(a,b,c,d){if(!((a=="add"||a=="remove")&&c!=this)){a=="destroy"&&this.remove(b,d);if(b&&a==="change:"+b.idAttribute){delete this._byId[b.previous(b.idAttribute)];this._byId[b.id]=b}this.trigger.apply(this,arguments)}}});f.each(["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf",
"shuffle","lastIndexOf","isEmpty","groupBy"],function(a){t.prototype[a]=function(){return f[a].apply(f,[this.models].concat(f.toArray(arguments)))}});var w=h.Router=function(a){a||(a={});if(a.routes)this.routes=a.routes;this._bindRoutes();this.initialize.apply(this,arguments)},D=/:\w+/g,E=/\*\w+/g,F=/[-[\]{}()+?.,\\^$|#\s]/g;f.extend(w.prototype,m,{isBackboneRouter:true,initialize:function(){},route:function(a,b,c){h.history||(h.history=new o);f.isRegExp(a)||(a=this._routeToRegExp(a));c||(c=this[b]);
h.history.route(a,f.bind(function(d){d=this._extractParameters(a,d);c&&c.apply(this,d);this.trigger.apply(this,["route:"+b].concat(d));h.history.trigger("route",this,b,d)},this));return this},navigate:function(a,b){h.history.navigate(a,b)},_bindRoutes:function(){if(this.routes){var a=[],b;for(b in this.routes)a.unshift([b,this.routes[b]]);b=0;for(var c=a.length;b<c;b++)this.route(a[b][0],a[b][1],this[a[b][1]])}},_routeToRegExp:function(a){a=a.replace(F,"\\$&").replace(D,"([^/]+)").replace(E,"(.*?)");
return RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}});var o=h.History=function(){this.handlers=[];f.bindAll(this,"checkUrl")},u=/^[#\/]/,G=/msie [\w.]+/;o.started=false;f.extend(o.prototype,m,{isBackboneHistory:true,interval:50,getHash:function(a){return(a=(a?a.location:window.location).href.match(/#(.*)$/))?a[1]:""},getFragment:function(a,b){if(a==null)if(this._hasPushState||b){a=window.location.pathname;var c=window.location.search;if(c)a+=c}else a=this.getHash();
a.indexOf(this.options.root)||(a=a.substr(this.options.root.length));return a.replace(u,"")},start:function(a){if(o.started)throw Error("Backbone.history has already been started");o.started=true;this.options=f.extend({},{root:"/"},this.options,a);this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);a=this.getFragment();var b=document.documentMode;if(b=G.exec(navigator.userAgent.toLowerCase())&&
(!b||b<=7)){this.iframe=l('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(a)}if(this._hasPushState)l(window).bind("popstate",this.checkUrl);else if(this._wantsHashChange&&"onhashchange"in window&&!b)l(window).bind("hashchange",this.checkUrl);else if(this._wantsHashChange)this._checkUrlInterval=setInterval(this.checkUrl,this.interval);this.fragment=a;a=window.location;b=a.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&
!this._hasPushState&&!b){this.fragment=this.getFragment(null,true);window.location.replace(this.options.root+"#"+this.fragment);return true}else if(this._wantsPushState&&this._hasPushState&&b&&a.hash){this.fragment=this.getHash().replace(u,"");window.history.replaceState({},document.title,a.protocol+"//"+a.host+this.options.root+this.fragment)}if(!this.options.silent)return this.loadUrl()},stop:function(){l(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);
o.started=false},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();if(a==this.fragment&&this.iframe)a=this.getFragment(this.getHash(this.iframe));if(a==this.fragment)return false;this.iframe&&this.navigate(a);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(a){var b=this.fragment=this.getFragment(a);return f.any(this.handlers,function(c){if(c.route.test(b)){c.callback(b);return true}})},navigate:function(a,b){if(!o.started)return false;
if(!b||b===true)b={trigger:b};var c=(a||"").replace(u,"");if(this.fragment!=c){if(this._hasPushState){if(c.indexOf(this.options.root)!=0)c=this.options.root+c;this.fragment=c;window.history[b.replace?"replaceState":"pushState"]({},document.title,c)}else if(this._wantsHashChange){this.fragment=c;this._updateHash(window.location,c,b.replace);if(this.iframe&&c!=this.getFragment(this.getHash(this.iframe))){b.replace||this.iframe.document.open().close();this._updateHash(this.iframe.location,c,b.replace)}}else window.location.assign(this.options.root+
a);b.trigger&&this.loadUrl(a)}},_updateHash:function(a,b,c){if(c)a.replace(a.toString().replace(/(javascript:|#).*$/,"")+"#"+b);else a.hash=b}});var x=h.View=function(a){this.cid=f.uniqueId("view");this._configure(a||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()},H=/^(\S+)\s*(.*)$/,y=["model","collection","el","id","attributes","className","tagName"];f.extend(x.prototype,m,{isBackboneView:true,tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},
render:function(){return this},remove:function(){this.$el.remove();return this},make:function(a,b,c){a=document.createElement(a);b&&l(a).attr(b);c&&l(a).html(c);return a},setElement:function(a,b){this.$el&&this.undelegateEvents();this.$el=a&&a.jquery?a:l(a);this.el=this.$el[0];b!==false&&this.delegateEvents();return this},delegateEvents:function(a){if(a||(a=p(this,"events"))){this.undelegateEvents();for(var b in a){var c=a[b];f.isFunction(c)||(c=this[a[b]]);if(!c)throw Error('Method "'+a[b]+'" does not exist');
var d=b.match(H),e=d[1];d=d[2];c=f.bind(c,this);e+=".delegateEvents"+this.cid;d===""?this.$el.bind(e,c):this.$el.delegate(d,e,c)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(a){if(this.options)a=f.extend({},this.options,a);for(var b=0,c=y.length;b<c;b++){var d=y[b];if(a[d])this[d]=a[d]}this.options=a},_ensureElement:function(){if(this.el)this.setElement(this.el,false);else{var a=p(this,"attributes")||{};if(this.id)a.id=this.id;if(this.className)a["class"]=
this.className;this.setElement(this.make(this.tagName,a),false)}}});s.extend=t.extend=w.extend=x.extend=function(a,b){var c=I(this,a,b);c.extend=this.extend;return c};var J={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};h.sync=function(a,b,c){var d=J[a];c||(c={});var e={type:d,dataType:"json"};if(!c.url)e.url=p(b,"url")||v();if(!c.data&&b&&(a=="create"||a=="update")){e.contentType="application/json";e.data=JSON.stringify(b.toJSON())}if(h.emulateJSON){e.contentType="application/x-www-form-urlencoded";
e.data=e.data?{model:e.data}:{}}if(h.emulateHTTP)if(d==="PUT"||d==="DELETE"){if(h.emulateJSON)e.data._method=d;e.type="POST";e.beforeSend=function(g){g.setRequestHeader("X-HTTP-Method-Override",d)}}if(e.type!=="GET"&&!h.emulateJSON)e.processData=false;return l.ajax(f.extend(e,c))};h.wrapError=function(a,b,c){return function(d,e){e=d===b?e:d;a?a(b,e,c):b.trigger("error",b,e,c)}};var z=function(){},I=function(a,b,c){var d;d=b&&b.hasOwnProperty("constructor")?b.constructor:function(){a.apply(this,arguments)};
f.extend(d,a);z.prototype=a.prototype;d.prototype=new z;b&&f.extend(d.prototype,b);c&&f.extend(d,c);d.prototype.constructor=d;d.__super__=a.prototype;return d},p=function(a,b){if(!(a&&a[b]))return null;return f.isFunction(a[b])?a[b]():a[b]},v=function(){throw Error('A "url" property or function must be specified');}}).call(this);
